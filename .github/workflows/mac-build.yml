name: Build Mac M1 App

on:
  workflow_dispatch: # Allows you to click a button to start the build

jobs:
  build:
    runs-on: macos-14 # This is the Apple Silicon (M1) runner
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10' 
        cache: 'pip'

    - name: Install System Dependencies
      run: |
        brew install python-tk@3.10
        # ffmpeg is needed for the build process checks, though the user still needs it locally later
        brew install ffmpeg 

    - name: Install Python Dependencies
      run: |
        # 1. Update pip to avoid installation errors
        python -m pip install --upgrade pip wheel setuptools
        
        # 2. CLEAN UP requirements.txt
        # We remove lines asking for Windows/Nvidia versions (torch, onnxruntime)
        # The -i '' is required for sed on macOS, but for Linux runners (GitHub Actions default) simply:
        sed -i '/torch/d' requirements.txt
        sed -i '/onnxruntime/d' requirements.txt
        sed -i '/tensorflow/d' requirements.txt

        # 3. Install Mac-Compatible Core Engines
        # Install standard PyTorch (supports Mac Silicon automatically)
        pip install torch torchvision torchaudio
        
        # Install CoreML support (Specific version required for M1/M2 as per DeepLiveCam docs)
        pip install onnxruntime-silicon==1.13.1

        # 4. Install the rest of the valid requirements
        pip install -r requirements.txt
        
        # 5. Install PyInstaller for building the app
        pip install pyinstaller

    - name: Download Models (Crucial step)
      run: |
        mkdir -p models
        echo "Downloading GFPGAN..."
        curl -L -o models/GFPGANv1.4.pth https://huggingface.co/hacksider/deep-live-cam/resolve/main/GFPGANv1.4.pth
        
        echo "Downloading Face Swapper..."
        curl -L -o models/inswapper_128_fp16.onnx https://huggingface.co/hacksider/deep-live-cam/resolve/main/inswapper_128_fp16.onnx

    - name: Build with PyInstaller
      run: |
        # We build a single windowed app, including the models folder
        # --add-data format is "source:dest"
        pyinstaller run.py --name "DeepLiveCam" \
          --windowed \
          --clean \
          --noconfirm \
          --add-data "models:models" \
          --icon "media/icon.png" \
          --collect-all "insightface" \
          --collect-all "onnxruntime"

    - name: Create DMG (Optional but cleaner)
      run: |
        # Simple DMG creation using hdiutil
        hdiutil create -volname "DeepLiveCam" -srcfolder dist/DeepLiveCam.app -ov -format UDZO DeepLiveCam.dmg

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: DeepLiveCam-M1-Build
        path: DeepLiveCam.dmg
