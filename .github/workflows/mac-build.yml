name: Build Mac M1 App

on:
  workflow_dispatch: # Allows you to click a button to start the build

jobs:
  build:
    runs-on: macos-14 # This is the Apple Silicon (M1) runner
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10' 
        cache: 'pip'

    - name: Install System Dependencies
      run: |
        brew install python-tk@3.10
        # ffmpeg is needed for the build process checks, though the user still needs it locally later
        brew install ffmpeg 

    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip wheel setuptools
        
        # Now we can just install directly because the file is fixed
        pip install -r requirements.txt
        
        pip install pyinstaller

    - name: Download Models (Crucial step)
      run: |
        mkdir -p models
        echo "Downloading GFPGAN..."
        curl -L -o models/GFPGANv1.4.pth https://huggingface.co/hacksider/deep-live-cam/resolve/main/GFPGANv1.4.pth
        
        echo "Downloading Face Swapper..."
        curl -L -o models/inswapper_128_fp16.onnx https://huggingface.co/hacksider/deep-live-cam/resolve/main/inswapper_128_fp16.onnx

    - name: Build with PyInstaller
      run: |
        # We build a single windowed app, including the models folder
        # --add-data format is "source:dest"
        pyinstaller run.py --name "DeepLiveCam" \
          --windowed \
          --clean \
          --noconfirm \
          --add-data "models:models" \
          --icon "media/icon.png" \
          --collect-all "insightface" \
          --collect-all "onnxruntime"

    - name: Create DMG (Optional but cleaner)
      run: |
        # Simple DMG creation using hdiutil
        hdiutil create -volname "DeepLiveCam" -srcfolder dist/DeepLiveCam.app -ov -format UDZO DeepLiveCam.dmg

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: DeepLiveCam-M1-Build
        path: DeepLiveCam.dmg
